name: Upload to MinIO
description: Upload to MinIO with unique URI suffix
inputs:
- {name: Data}  # Input file path or directory
- {name: MinIO path prefix, type: String}  # MinIO bucket path prefix
outputs:
- {name: MinIO path, type: String}  # Output MinIO path
metadata:
  annotations:
    author: Nikhil <nikhil.v@mobiusdtaas.ai>
implementation:
    container:
        image: ubuntu:20.04  # Using Ubuntu base image
        command:
        - sh
        - -ex
        - -c
        - |
            # Update the package list
            apt-get update

            # Install wget
            apt-get install wget -y

            # Download the MinIO client (mc)
            wget https://dl.min.io/client/mc/release/linux-amd64/mc

            # Make mc executable
            chmod +x mc

            # Move mc to /usr/local/bin so it's available in the PATH
            mv mc /usr/local/bin/

            # Set up MinIO alias with your local MinIO instance
            mc alias set myminio http://192.168.28.15:9000 minio minio123

            # Shorten the prefix to avoid bucket name being too long
            SHORT_PREFIX=$(echo "$1" | cut -c 1-30)

            # Copy the data from the input path to MinIO with a unique suffix
            mc cp --recursive "$0" "myminio/${SHORT_PREFIX}_{{workflow.uid}}_{{pod.name}}"

            # Create the output directory locally if needed
            mkdir -p "$(dirname "$2")"

            # Save the MinIO path to the output
            echo "myminio/${SHORT_PREFIX}_{{workflow.uid}}_{{pod.name}}" > "$2"
        - inputPath: Data
        - concat: [{inputValue: MinIO path prefix}, '{{workflow.uid}}_{{pod.name}}']
        - outputPath: MinIO path
