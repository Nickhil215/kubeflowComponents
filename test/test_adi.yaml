name: Trigger ML Pipeline 100 Times
description: Executes the same ML pipeline trigger API request 100 times.

inputs: []

outputs:
  - {name: responseLog, type: string}

implementation:
  container:
    image: python:3.8
    command:
      - sh
      - -c
      - |
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests || \
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --user requests
        python3 -u - <<'EOF'
        import requests
        import json
        import time

        url = "https://igs.gov-cloud.ai/bob-service-test/v1.0/pipeline/trigger/ml?pipelineId=019ac0c8-b1f7-736d-bad5-5d93cf8ff35a"

        payload = {
            "pipelineType": "ML",
            "containerResources": {},
            "experimentId": "43590dc1-63af-442b-bbc0-c59673309585",
            "enableCaching": True,
            "parameters": {
                "model_id": "13",
                "execution_id": "mpqetest",
                "json_url": "https://cdn-new.gov-cloud.ai/_ENC(4+j2JOgE1QQdq6yO427Uztql2TlqlMwKUOg5QJcVQ5XUgB/GP4/J5WLrrqWMDU3q)/bottle/limka/soda/81195c02-25ad-4ae1-944a-4c1b22b03967_$$$$_V1_result_batch_0001_1765375170.json",
                "learning_mode": "normal",
                "previous_data_url": "https://cdn-new.gov-cloud.ai/_ENC(4+j2JOgE1QQdq6yO427Uztql2TlqlMwKUOg5QJcVQ5XUgB/GP4/J5WLrrqWMDU3q)/MPQE1/c28fd563-512b-4ffd-9c6c-beacbf8bb907_$$$$_V1_all_data.pkl",
                "replay_ratio": "0.3",
                "model_name": "mpqe",
                "config_str": "{\"embed_dim\": 128, \"num_layers\": 3, \"dropout\": 0.5, \"depth\": 0, \"use_cuda\": false, \"optimizer\": \"adam\", \"learning_rate\": 0.01, \"batch_size\": 512, \"inter_weight\": 0.005, \"path_weight\": 0.01}",
                "previous_model_url": "https://cdn-new.gov-cloud.ai/_ENC(4+j2JOgE1QQdq6yO427Uztql2TlqlMwKUOg5QJcVQ5XUgB/GP4/J5WLrrqWMDU3q)/MPQE1/10c6599c-3654-4ccc-b77e-785d954535d5_$$$$_V1_trained_model_replay.pt",
                "continual_strategy": "replay",
                "project_id": "3e694697-078a-7755-a025-58d617a620f1",
                "batch_id": "batch1",
                "skipvalue": 0,
                "limitvalue": 2000
            },
            "version": 1
        }

        headers = {
            "accept": "application/json",
            "Authorization": "Bearer <YOUR TOKEN HERE>"
        }

        responses = []
        for i in range(100):
            try:
                r = requests.post(url, json=payload, headers=headers)
                responses.append({"index": i, "status": r.status_code, "body": r.text})
                time.sleep(0.3)  # slight throttle to avoid rate limits
            except Exception as e:
                responses.append({"index": i, "error": str(e)})
                time.sleep(0.5)

        print(json.dumps(responses))
        EOF
