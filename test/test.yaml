name: Trigger ML Pipeline 100 Times
description: Executes the same ML pipeline trigger API request 100 times.

inputs: []

outputs:
  - {name: responseLog, type: string}

implementation:
  container:
    image: python:3.8
    command:
      - sh
      - -c
      - |
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests || \
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests --user
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import requests
        import json

        url = "https://ig.gov-cloud.ai/bob-service-test/v1.0/pipeline/trigger/ml?pipelineId=019b021a-d758-71ea-9417-64ef0c0f404b"

        payload = json.dumps({
        "pipelineType": "ML",
        "containerResources": {},
        "experimentId": "e5fc7d4b-1fa9-4a84-acf5-f8731007d29f",
        "enableCaching": True,
        "parameters": {},
        "version": 1
        })
        headers = {
        'accept': 'application/json',
        'Authorization': 'Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI3Ny1NUVdFRTNHZE5adGlsWU5IYmpsa2dVSkpaWUJWVmN1UmFZdHl5ejFjIn0.eyJleHAiOjE3NTQ0MzYwMDAsImlhdCI6MTc1NDQwMDAwMCwianRpIjoiNmM3ZjhiM2ItMjg1My00NWU0LWE4MzEtNWYyOGE4YTFjN2JkIiwiaXNzIjoiaHR0cDovL2tleWNsb2FrLXNlcnZpY2Uua2V5Y2xvYWsuc3ZjLmNsdXN0ZXIubG9jYWw6ODA4MC9yZWFsbXMvbWFzdGVyIiwiYXVkIjoiYWNjb3VudCIsInN1YiI6IjJjZjc2ZTVmLTI2YWQtNGYyYy1iY2NjLWY0YmMxZTdiZmI2NCIsInR5cCI6IkJlYXJlciIsImF6cCI6IkhPTEFDUkFDWV9tb2JpdXMiLCJzaWQiOiJjZGU3NzhlNS0wNWNiLTQzMDktYjE0NC0wMWFhMTBlOGU4NDkiLCJhY3IiOiIxIiwiYWxsb3dlZC1vcmlnaW5zIjpbIi8qIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJkZWZhdWx0LXJvbGVzLW1hc3RlciIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJIT0xBQ1JBQ1lfbW9iaXVzIjp7InJvbGVzIjpbIkhPTEFDUkFDWV9VU0VSIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJyZXF1ZXN0ZXJUeXBlIjoiVEVOQU5UIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsIm5hbWUiOiJBaWR0YWFzIEFpZHRhYXMiLCJ0ZW5hbnRJZCI6IjJjZjc2ZTVmLTI2YWQtNGYyYy1iY2NjLWY0YmMxZTdiZmI2NCIsInBsYXRmb3JtSWQiOiJtb2JpdXMiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJwYXNzd29yZF90ZW5hbnRfYWlkdGFhc0BnYWlhbnNvbHV0aW9ucy5jb20iLCJnaXZlbl9uYW1lIjoiQWlkdGFhcyIsImZhbWlseV9uYW1lIjoiQWlkdGFhcyIsImVtYWlsIjoicGFzc3dvcmRfdGVuYW50X2FpZHRhYXNAZ2FpYW5zb2x1dGlvbnMuY29tIn0.TDeZUlqp8ky246ZO8GpHoXRAfoo2eMdVgqyuB5gCfuHTjKPnAcbh7NztK5wbfncXZ-1TYtvMp-tuQ5nVy21PLdvNcZ15LANsLJzbxF0ORVv4QyfmbNzNjkJGGGCdD6pqZPwZarVHU73hox_VkeKlMohf9AcAJQE5xk2IXbT1ostmdbwZsPfw5F_lVUb6v8wcrqFTnt6hJRNOqDIYQMGkMkc2RRAVHTVfOnBZujBX4TADafzO2RVqUq5tNk_JJ33e42FGXbhbxwnun5h2PVSqJof5oBjnRn46l0HJufj5ZvqkXd7nD-zI6AgCcobdez7U_r4Nd5UcTzkbdx4yA2A7-Q',
        'Content-Type': 'application/json'
        }

        for i in range(100):
            response = requests.request("POST", url, headers=headers, data=payload)
            print(response.json())
            
        def write_output(path, value):
            os.makedirs(os.path.dirname(path), exist_ok=True)
            with open(path, "w") as f:
                f.write(value)

        write_output(args.responseLog, '\\n\\n'.join(logs))

    args:
      - --responseLog
      - {outputPath: responseLog}
