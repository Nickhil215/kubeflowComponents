name: Trigger ML Pipeline 100 Times
description: Executes the same ML pipeline trigger API request 100 times.

inputs: []

outputs:
  - {name: responseLog, type: string}

implementation:
  container:
    image: python:3.8
    command:
      - sh
      - -c
      - |
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests || \
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests --user
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import requests
        import json

        url = "https://ig.mobiusdtaas.ai/bob-service-test/v1.0/pipeline/trigger/ml?pipelineId=019b2e05-d4f5-7fe7-b105-a84e26a78069"

        payload = json.dumps({
        "pipelineType": "ML",
        "containerResources": {},
        "experimentId": "9c11c75f-6d21-412a-b470-e68e1afe106d",
        "enableCaching": True,
        "parameters": {},
        "version": 1
        })
        headers = {
        'accept': 'application/json',
        'Authorization': 'Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI3Ny1NUVdFRTNHZE5adGlsWU5IYmpsa2dVSkpaWUJWVmN1UmFZdHl5ejFjIn0.eyJleHAiOjE3NjYwMzkwODgsImlhdCI6MTc2NjAwMzA4OCwianRpIjoiYWU4MDc5M2YtZTYyYy00Y2VkLTk1N2EtZTRiOTNjMmY1NWM5IiwiaXNzIjoiaHR0cDovL2tleWNsb2FrLXNlcnZpY2Uua2V5Y2xvYWsuc3ZjLmNsdXN0ZXIubG9jYWw6ODA4MC9yZWFsbXMvbWFzdGVyIiwiYXVkIjoiYWNjb3VudCIsInN1YiI6IjJjZjc2ZTVmLTI2YWQtNGYyYy1iY2NjLWY0YmMxZTdiZmI2NCIsInR5cCI6IkJlYXJlciIsImF6cCI6IkhPTEFDUkFDWV9tb2JpdXMiLCJzaWQiOiIxZGI5N2Y3Yy1jZjgxLTQ2NmItYjE2Mi1jYTg2NjM3NDYzYzYiLCJhY3IiOiIxIiwiYWxsb3dlZC1vcmlnaW5zIjpbIi8qIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJkZWZhdWx0LXJvbGVzLW1hc3RlciIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJIT0xBQ1JBQ1lfbW9iaXVzIjp7InJvbGVzIjpbIkhPTEFDUkFDWV9VU0VSIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJyZXF1ZXN0ZXJUeXBlIjoiVEVOQU5UIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsIm5hbWUiOiJBaWR0YWFzIEFpZHRhYXMiLCJ0ZW5hbnRJZCI6IjJjZjc2ZTVmLTI2YWQtNGYyYy1iY2NjLWY0YmMxZTdiZmI2NCIsInBsYXRmb3JtSWQiOiJtb2JpdXMiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJwYXNzd29yZF90ZW5hbnRfYWlkdGFhc0BnYWlhbnNvbHV0aW9ucy5jb20iLCJnaXZlbl9uYW1lIjoiQWlkdGFhcyIsImZhbWlseV9uYW1lIjoiQWlkdGFhcyIsImVtYWlsIjoicGFzc3dvcmRfdGVuYW50X2FpZHRhYXNAZ2FpYW5zb2x1dGlvbnMuY29tIn0.EuDZ7qot75k3cjufQG5k2D4f6aMvTA3rihidsspQT6ENXZQG8BLvDBkbi9Rs27h4Z5hm03U5D-0ztkTnB_ZnMGqUsgjohNpNDDLjh6vHEDE_TkbVzp9Pe1PdX2Ob_rEz4juo-kkwLXek0W4ok1MPWd_eRL6qL2R6oeWFQT1Em03-r-bwWEgMeh8Ce-gGoYNRMNCnVx5gncwHI984BS92x6kFw4OUiT1A60hy6VQzB72yCR8OLoywZOxyfuipb6G9gAYCYAaITccWEJAO6Z6_pm6Sb_fpS1v96CMKbkPccLLoSmDMxT0mkbxo5lUMYrGcQICeJgcT4g0uGzKL2AY6Vg',
        'Content-Type': 'application/json'
        }

        for i in range(100):
            response = requests.request("POST", url, headers=headers, data=payload)
            print(response.json())
            
        def write_output(path, value):
            os.makedirs(os.path.dirname(path), exist_ok=True)
            with open(path, "w") as f:
                f.write(value)

        write_output(args.responseLog, '\\n\\n'.join(logs))

    args:
      - --responseLog
      - {outputPath: responseLog}
