name: Trigger ML Pipeline 100 Times
description: Executes the same ML pipeline trigger API request 100 times in sequence and returns combined results.

inputs: []

outputs:
  - {name: responseLog, type: string}

implementation:
  container:
    image: python:3.8
    command:
      - sh
      - -c
      - |
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests || \
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests --user
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import requests
        import json
        import argparse
        import os
        import time

        parser = argparse.ArgumentParser()
        parser.add_argument("--responseLog", type=str, required=True)
        args = parser.parse_args()

        url = "https://ig.gov-cloud.ai/bob-service-test/v1.0/pipeline/trigger/ml?pipelineId=019b021a-d758-71ea-9417-64ef0c0f404b"

        payload = {
            "pipelineType": "ML",
            "containerResources": {},
            "experimentId": "e5fc7d4b-1fa9-4a84-acf5-f8731007d29f",
            "enableCaching": True,
            "parameters": {},
            "version": 1
        }

        headers = {
          'accept': 'application/json',
          'Authorization': 'Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI3Ny1NUVdFRTNHZE5adGlsWU5IYmpsa2dVSkpaWUJWVmN1UmFZdHl5ejFjIn0.eyJleHAiOjE3NTQ0MzYwMDAsImlhdCI6MTc1NDQwMDAwMCwianRpIjoiNmM3ZjhiM2ItMjg1My00NWU0LWE4MzEtNWYyOGE4YTFjN2JkIiwiaXNzIjoiaHR0cDovL2tleWNsb2FrLXNlcnZpY2Uua2V5Y2xvYWsuc3ZjLmNsdXN0ZXIubG9jYWw6ODA4MC9yZWFsbXMvbWFzdGVyIiwiYXVkIjoiYWNjb3VudCIsInN1YiI6IjJjZjc2ZTVmLTI2YWQtNGYyYy1iY2NjLWY0YmMxZTdiZmI2NCIsInR5cCI6IkJlYXJlciIsImF6cCI6IkhPTEFDUkFDWV9tb2JpdXMiLCJzaWQiOiJjZGU3NzhlNS0wNWNiLTQzMDktYjE0NC0wMWFhMTBlOGU4NDkiLCJhY3IiOiIxIiwiYWxsb3dlZC1vcmlnaW5zIjpbIi8qIl0sInJlYW1fYWNjZXNzIjp7InJvbGVzIjpbImRlZmF1bHQtcm9sZXMtbWFzdGVyIiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7IkhPTEFDUkFDWV9tb2JpdXMiOnsicm9sZXMiOlsiSE9MQUNSQUNZX1VTRVIiXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInJlcXVlc3RlclR5cGUiOiJURU5BTlQiLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwibmFtZSI6IkFpZHRhYXMgQWlkdGFhcyIsInRlbmFudElkIjoiMmNmNzZlNWYtMjZhZC00ZjJjLWJjY2MtZjRiYzFlN2JmYjY0IiwicGxhdGZvcm1JZCI6Im1vYml1cyIsInByZWZlcnJlZF91c2VybmFtZSI6InBhc3N3b3JkX3RlbmFudF9haWR0YWFzQGdhaWFuc29sdXRpb25zLmNvbSIsImdpdmVuX25hbWUiOiJBaWR0YWFzIiwiZmFtaWx5X25hbWUiOiJBaWR0YWFzIiwiZW1haWwiOiJwYXNzd29yZF90ZW5hbnRfYWlkdGFhc0BnYWlhbnNvbHV0aW9ucy5jb20ifQ.TDeZUlqp8ky246ZO8GpHoXRAfoo2eMdVgqyuB5gCfuHTjKPnAcbh7NztK5wbfncXZ-1TYtvMp-tuQ5nVy21PLdvNcZ15LANsLJzbxF0ORVv4QyfmbNzNjkJGGGCdD6pqZPwZarVHU73hox_VkeKlMohf9AcAJQE5xk2IXbT1ostmdbwZsPfw5F_lVUb6v8wcrqFTnt6hJRNOqDIYQMGkMkc2RRAVHTVfOnBZujBX4TADafzO2RVqUq5tNk_JJ33e42FGXbhbxwnun5h2PVSqJof5oBjnRn46l0HJufj5ZvqkXd7nD-zI6AgCcobdez7U_r4Nd5UcTzkbdx4yA2A7-Q',
          'Content-Type': 'application/json'
        }

        logs = []
        for i in range(100):
            print(f"Request {i+1}/100")
            resp = requests.post(url, headers=headers, json=payload)
            logs.append(f"Run {i+1}: {resp.status_code} | {resp.text}")

        def write_output(path, value):
            os.makedirs(os.path.dirname(path), exist_ok=True)
            with open(path, "w") as f:
                f.write(value)

        write_output(args.responseLog, "\n\n".join(logs))

    args:
      - --responseLog
      - {outputPath: responseLog}
