name: Trigger ML Pipeline 100 Times
description: Executes the same ML pipeline trigger API request 100 times.

inputs: []

outputs:
  - {name: responseLog, type: string}

implementation:
  container:
    image: python:3.8
    command:
      - sh
      - -c
      - |
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests || \
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests --user
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import requests
        import argparse
        import os

        parser = argparse.ArgumentParser()
        parser.add_argument("--responseLog", required=True)
        args = parser.parse_args()

        url = "https://ig.gov-cloud.ai/bob-service-test/v1.0/pipeline/trigger/ml?pipelineId=019b021a-d758-71ea-9417-64ef0c0f404b"

        payload = {
            "pipelineType": "ML",
            "containerResources": {},
            "experimentId": "e5fc7d4b-1fa9-4a84-acf5-f8731007d29f",
            "enableCaching": True,
            "parameters": {},
            "version": 1
        }

        headers = {
            "accept": "application/json",
            "Authorization": "Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI3Ny1NUVdFRTNHZE5adGlsWU5IYmpsa2dVSkpaWUJWVmN1UmFZdHl5ejFjIn0....(trimmed)...",
            "Content-Type": "application/json"
        }

        logs = []
        for i in range(100):
            resp = requests.post(url, headers=headers, json=payload)
            print(resp.json())
            logs.append(f"Run {i+1}: {resp.status_code} | {resp.text}")

        def write_output(path, value):
            os.makedirs(os.path.dirname(path), exist_ok=True)
            with open(path, "w") as f:
                f.write(value)

        write_output(args.responseLog, '\\n\\n'.join(logs))

    args:
      - --responseLog
      - {outputPath: responseLog}
